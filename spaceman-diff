#!/bin/sh
#
# spaceman-diff
# ...because you're too busy to leave the command line, dammit.
#
# Enjoy.

set -e

help()
{
  cat <<EOF
  This should normally be called via \`git-diff(1)\`.

  USAGE:
    spaceman-diff fileA shaA modeA fileB shaB modeB
EOF
}

if [ "$1" = "" ] ; then
  help
  exit
fi

filename=`basename $1`
extension=${filename##*.}

screenWidth=$(stty size | cut -d " " -f2)
screenWidthMinusBuffer=$(expr $screenWidth - 4)
perDiffWidth=$(expr $screenWidthMinusBuffer / 2)

fileA=$2
fileB=$5

case "$extension" in
  "jpg"|"jpeg"|"gif"|"png")
    outputA=`convert $fileA jpg:- | jp2a --color --width=$perDiffWidth -`
    outputB=`convert $fileB jpg:- | jp2a --color --width=$perDiffWidth -`

    heightA=`echo "$outputA" | wc -l | xargs`
    heightB=`echo "$outputB" | wc -l | xargs`
    max=`echo "$heightA\n$heightB" | sort -nr | head -n1`

    sizeA=$(ls -lh $fileA | cut -d" " -f9)
    sizeB=$(ls -lh $fileB | cut -d" " -f9)
    echo "Filesize A: $sizeA, Filesize B: $sizeB"

    for (( i=1; i<=$max; i++ ))
    do
      A=$(echo "$outputA" | sed -n ${i}p)
      B=$(echo "$outputB" | sed -n ${i}p)

      if [ "$A" = "" ] ; then
        A=$(yes " " | head -n$perDiffWidth | tr -d '\n')
      fi

      if [ "$B" = "" ] ; then
        B=$(yes " " | head -n$perDiffWidth | tr -d '\n')
      fi

      echo "$A    $B"
    done
  ;;
  *)
    # Fallback to Git's own diffing
    git diff --no-ext-diff $5 $1
  ;;
esac
